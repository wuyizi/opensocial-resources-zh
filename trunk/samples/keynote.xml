<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="Keynote Demo"
               author_email="your.email@foo.bar" scrolling="true" height="500">
    <Require feature="opensocial-0.7"/>
    <Require feature="dynamic-height"/>
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
      <script type="text/javascript">

        var me;                   // opensocial.Person
        var myFriends;            // opensocial.Collection
        var myComments;           // {'c': json}
        var allComments;          // {id: {'c': json}}

        function commentHTML(p, cs) {
          var html = new Array();
          html.push("<li>" + p.getDisplayName() + "<ul>");
          var len = cs.length;
          for (var i = 0; i < len; ++i) {
            html.push("<li>" + cs[i] + "</li>");
          }
          html.push("</ul></li>");
          return html.join('');
        };
        
        function parseData(data) {
          var json = data['c'];
          var cs = [];
          try  {
            cs = gadgets.json.parse(gadgets.util.unescapeString(json)) || [];
          } catch(e) {
            cs = [];
          }
          return cs;
        };

        function showComments() {
          var html = new Array();
          for (var friendId in allComments) {
            html.push(commentHTML(myFriends.getById(friendId), allComments[friendId]));
          }
          html.push(commentHTML(me, myComments));
          document.getElementById('comments').innerHTML = html.join('');
        };

        function onSubmit() {
          var textArea = document.getElementById('content');
          var c = textArea.value;
          var cs = parseData(myComments);
          cs.push(c);
          json = gadgets.json.stringify(cs);
          var req = opensocial.newDataRequest();
          req.add(req.newUpdatePersonAppDataRequest('VIEWER', 'c', json));
          req.send(function(dataResponse) {
            alert("发布成功");
            postReadActivity(c);
          });          
        };
        function postReadActivity(c) {
          if (c.length > 10) c = c.substring(0, 10) + "...";
          var title = "发布了评论:" + c;
          var params = {};
          params[opensocial.Activity.Field.TITLE] = title;
          var activity = opensocial.newActivity(params)
          opensocial.requestCreateActivity(activity, opensocial.CreateActivityPriority.HIGH, 
              function() { reloadAll(); });
        };

        function showBasic() {

        };
    
        function reloadAll() {
          var req = new opensocial.DataRequest();
          req.add(req.newFetchPersonRequest('VIEWER'), 'v');
          req.add(req.newFetchPeopleRequest('VIEWER_FRIENDS'), 'vf');
          req.add(req.newFetchPersonAppDataRequest('VIEWER', 'c'), 'vd');
          req.add(req.newFetchPersonAppDataRequest('VIEWER_FRIENDS', 'c'), 'vfd');
          req.send(onReloadAll);
        };
        function onReloadAll(dataResponse) {
          window['data'] = dataResponse;
          me = dataResponse.get('v').getData() || {};
          myFriends = dataResponse.get('vf').getData() || {};
          myComments = dataResponse.get('vd').getData()[me.getId()] || {};  // {'c': json}
          allComments = dataResponse.get('vfd').getData() || {};  // {id:{'c': json}}
          showBasic();
          showComments();
        };

        function init() {
          reloadAll();
        };
        gadgets.util.registerOnLoadHandler(init);
      </script>

      <!-- 用于显示的DOM -->
      <div id='main'>
        <b>评论这篇文章</b>
        <textarea id='content'></textarea>
        <button onclick="onSubmit()">发布</button>
        <b>朋友们对文章的评论</b>
        <ul id='comments'></ul>
      </div>
     ]]>
  </Content>
</Module>


